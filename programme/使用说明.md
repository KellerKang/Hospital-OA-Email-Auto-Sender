# 自动化数据提取与邮件发送系统使用说明

## 系统概述

本系统实现从Oracle数据库自动提取数据，保存为Excel文件，并通过院内OA系统自动发送邮件的完整流程。

## 环境要求

### 系统要求
- **操作系统**: Windows 10/11
- **Python版本**: 3.8 或更高版本
- **内存**: 至少4GB RAM
- **磁盘空间**: 至少1GB可用空间

### 软件依赖
- **Oracle Instant Client**: 用于连接Oracle数据库
- **Google Chrome**: 用于Web自动化
- **Python包**: 见requirements.txt

## 安装步骤

### 1. 安装Python环境
```bash
# 下载并安装Python 3.8+
# 确保勾选"Add Python to PATH"
```

### 2. 安装Oracle Instant Client
1. 从Oracle官网下载Instant Client
2. 解压到指定目录（如：C:\oracle\instantclient_19_19）
3. 将目录添加到系统PATH环境变量

### 3. 安装Python依赖包
```bash
# 进入项目目录
cd programme

# 安装依赖包
pip install -r requirements.txt
```

### 4. 下载ChromeDriver
系统会自动下载ChromeDriver，无需手动安装。

## 配置说明

### 1. 数据库配置
编辑 `config.py` 文件中的 `DATABASE_CONFIG` 部分：

```python
DATABASE_CONFIG = {
    'host': 'your_oracle_host',        # Oracle数据库主机地址
    'port': 1521,                      # 端口号
    'service_name': 'your_service_name', # 服务名
    'username': 'your_username',       # 用户名
    'password': 'your_password',       # 密码
    'encoding': 'UTF-8'
}
```

### 2. SQL查询配置
在 `config.py` 中修改 `QUERY_CONFIG` 部分：

```python
QUERY_CONFIG = {
    'sql_query': '''
        SELECT 
            column1,
            column2,
            column3,
            TO_CHAR(SYSDATE, 'YYYY-MM-DD') as report_date
        FROM your_table_name
        WHERE condition = 'your_condition'
        ORDER BY column1
    ''',
    'sheet_name': '数据报表'
}
```

### 3. 邮件配置
在 `config.py` 中修改 `EMAIL_CONFIG` 部分：

```python
EMAIL_CONFIG = {
    'oa_url': 'http://your-oa-system.com',  # OA系统地址
    'username': 'your_email_username',      # 邮箱用户名
    'password': 'your_email_password',      # 邮箱密码
    'recipients': ['recipient1@example.com', 'recipient2@example.com'],
    'subject_prefix': '数据报表'
}
```

### 4. 文件配置
在 `config.py` 中修改 `FILE_CONFIG` 部分：

```python
FILE_CONFIG = {
    'output_dir': 'D:\\data_reports',  # 输出目录
    'file_prefix': '数据报表',         # 文件前缀
    'file_extension': '.xlsx'          # 文件扩展名
}
```

### 5. 时间配置
在 `config.py` 中修改 `TIME_CONFIG` 部分：

```python
TIME_CONFIG = {
    'schedule_time': '09:00',  # 每日执行时间
    'timezone': 'Asia/Shanghai'
}
```

## 使用步骤

### 1. 系统测试
```bash
# 测试数据库连接和OA系统连接
python main.py --test
```

### 2. 数据提取测试
```bash
# 仅测试数据提取功能
python main.py --extract
```

### 3. 完整流程测试
```bash
# 运行完整的自动化流程
python main.py --run
```

### 4. 设置定时任务
```bash
# 创建每日自动运行的计划任务
python schedule_task.py --create
```

### 5. 管理计划任务
```bash
# 查询任务状态
python schedule_task.py --query

# 立即运行任务
python schedule_task.py --run

# 删除任务
python schedule_task.py --delete

# 列出所有任务
python schedule_task.py --list
```

## 日志查看

### 日志文件位置
- `main.log`: 主程序执行日志
- `database_extractor.log`: 数据库操作日志
- `email_sender.log`: 邮件发送日志

### 日志内容
- 执行时间戳
- 操作步骤
- 错误信息
- 性能指标

## 故障排除

### 常见问题

#### 1. 数据库连接失败
**症状**: 提示"数据库连接失败"
**解决方案**:
- 检查数据库配置信息
- 确认Oracle Instant Client已正确安装
- 验证网络连接和防火墙设置
- 检查数据库用户权限

#### 2. OA系统登录失败
**症状**: 提示"OA系统登录失败"
**解决方案**:
- 检查OA系统地址是否正确
- 验证用户名密码
- 确认OA系统可正常访问
- 检查网络连接

#### 3. 文件保存失败
**症状**: 提示"保存Excel文件失败"
**解决方案**:
- 检查输出目录权限
- 确认磁盘空间充足
- 验证文件路径格式

#### 4. 计划任务创建失败
**症状**: 提示"Windows计划任务创建失败"
**解决方案**:
- 以管理员身份运行命令提示符
- 检查任务名称是否重复
- 确认Python路径正确

### 调试模式

启用详细日志输出：
```python
# 在config.py中修改日志级别
logging.basicConfig(level=logging.DEBUG)
```

## 维护建议

### 定期维护
1. **每周检查**: 查看日志文件，确认系统正常运行
2. **每月清理**: 清理旧的Excel文件，释放磁盘空间
3. **季度更新**: 更新Python依赖包和Chrome浏览器

### 监控指标
- 执行成功率
- 执行时间
- 错误频率
- 磁盘使用情况

### 备份策略
- 定期备份配置文件
- 备份重要的Excel文件
- 保存系统日志

## 技术支持

如遇到问题，请：
1. 查看相关日志文件
2. 检查配置是否正确
3. 参考故障排除部分
4. 联系技术支持团队

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持Oracle数据库连接
- 支持Excel文件生成
- 支持OA系统邮件发送
- 支持Windows计划任务 